<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Login - Catch the Offer</title>
<title> Catch the Offer</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;800&display=swap" rel="stylesheet">

<style>
:root{
  --txt:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; --accent2:#fbbf24; --danger:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
  color:var(--txt);
  background: radial-gradient(1200px 800px at 10% 10%, #0b1221, transparent 60%),
              radial-gradient(1000px 600px at 90% 90%, #122036, transparent 55%),
              linear-gradient(135deg,#0f172a,#1e293b);
  overflow:hidden;
}

/* GAME AREA */
.game-container{
  position:relative; width:100vw; height:100vh; overflow:hidden;
  background: url('image bg.png') no-repeat center center/cover;
}
.hud{
  position:absolute; left:0; right:0; top:0; display:flex; align-items:center; justify-content:space-between;
  padding:10px 14px; gap:8px; background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,0));
  z-index:20;
}
#score{ font-weight:800; font-size:clamp(16px,4vw,22px); text-shadow: 0 1px 3px rgba(0,0,0,.5); }
.hearts{ display:flex; align-items:center; gap:4px; }
.heart{ width:26px; height:26px; }

.pill{
  display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
  background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); backdrop-filter: blur(6px);
  font-weight:700; box-shadow: 0 8px 24px rgba(0,0,0,.25);
}
#offersPill{ cursor:default; }

#basket { 
  position: absolute; 
  bottom: 5vh; 
  left: 0; 
  width: 30vw; 
  height: 20vh; /* ✅ gives it visible space */ 
  max-height: 180px;
  background: url('basket main cyan.png') no-repeat center/contain;
 }
#basket.glow {
  filter: drop-shadow(0 0 12px rgba(255,213,79,.85));
}
.falling-item {
  position:absolute;
  width:74px; /* was 64px */
  height:74px; /* was 64px */
  background-size:contain;
  background-repeat:no-repeat;
  background-position:center;
  filter: drop-shadow(0 8px 12px rgba(0,0,0,.35));
  will-change: transform, top, left;
}



/* Trails & particles */
.ball-trail{
  position:absolute; width:12px; height:12px; border-radius:50%;
  background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.9), rgba(125,211,252,.7) 55%, transparent 70%);
  filter: blur(1px); opacity:.9; animation: trailFade .4s ease-out forwards;
}
@keyframes trailFade{ to{ transform: translateY(6px) scale(.7); opacity:0; } }

.particle{
  position:absolute; width:6px; height:6px; border-radius:50%;
  background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
  filter: blur(.2px);
  animation: pop .5s ease-out forwards;
}
@keyframes pop{
  0%{ opacity:1; transform: translate(0,0) scale(1); }
  100%{ opacity:0; transform: translate(var(--dx), var(--dy)) scale(.8); }
}
.confetti{
  position:absolute; width:8px; height:14px; background: var(--accent2);
  transform: rotate(0deg);
  animation: confFall .8s ease-out forwards;
}
.confetti:nth-child(3n){ background: #fb7185; }
.confetti:nth-child(3n+1){ background: #34d399; }
.confetti:nth-child(3n+2){ background: #60a5fa; }
@keyframes confFall{
  0%{ opacity:1; transform: translate(0,0) rotate(0deg); }
  100%{ opacity:0; transform: translate(var(--dx), var(--dy)) rotate(220deg); }
}

/* Flash & shake */
#flash{ position: fixed; inset:0; background: rgba(255,107,107,.45); opacity:0; pointer-events:none; z-index: 9998; transition: opacity .18s ease; }
.shake{ animation: shake .25s ease; }
@keyframes shake{
  0%{ transform: translate(0,0); } 25%{ transform: translate(4px, -3px); }
  50%{ transform: translate(-4px, 2px); } 75%{ transform: translate(3px, 3px); } 100%{ transform: translate(0,0); }
}

/* Floating +1 text */
.float-text{
  position: absolute; z-index: 9999; pointer-events:none; font-weight:800; font-size: clamp(18px,4vw,28px);
  color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,.5); animation: floatUp .7s ease-out forwards;
}
@keyframes floatUp{
  0%{ opacity:0; transform: translate(-50%, -10px) scale(.9); }
  15%{ opacity:1; }
  100%{ opacity:0; transform: translate(-50%, -60px) scale(1.05); }
}

/* On-screen controls (mobile) */
/* On-screen controls (mobile) */
.ctrl {
  position: absolute;
  bottom: 10vh;
  width: 64px;
  height: 64px;
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 28px;
  font-weight: 800;
  color: transparent; /* hide text since we use images */
  background: none;   /* remove previous gradient background */
  user-select: none;
  -webkit-user-select: none;
  touch-action: manipulation;
  z-index: 30;
  transition: transform 0.15s ease, box-shadow 0.25s ease;
  overflow: hidden;
}

/* Add the left/right images */
#left-btn, 
#right-btn {
  position: absolute;
  bottom: 10vh;
  width: 80px;
  height: 80px;
  background: transparent;   /* 🔹 fully transparent */
  border: none;              /* 🔹 no border */
  color: white;              /* arrow color */
  font-size: 48px;           /* arrow size */
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  user-select: none;
}

#left-btn {
  left: 16px;
}

#right-btn {
  right: 16px;
}



/* When pressed/touched: glow effect */
.ctrl:active {
  transform: scale(0.9);
  box-shadow: 
    0 0 15px #06b6d4,
    0 0 30px #06b6d4,
    0 0 45px #06b6d4;
}

/* Optional ripple animation */
.ctrl::after {
  content: '';
  position: absolute;
  border-radius: 50%;
  width: 200%;
  height: 200%;
  top: 50%;
  left: 50%;
  pointer-events: none;
  background: rgba(255, 255, 255, 0.4);
  transform: translate(-50%, -50%) scale(0);
  transition: transform 0.4s ease, opacity 0.6s ease;
}

.ctrl:active::after {
  transform: translate(-50%, -50%) scale(1);
  opacity: 0;
}
/* Glow animation */
.ctrl.glow-effect {
  box-shadow:
    0 0 15px #06b6d4,
    0 0 30px #06b6d4,
    0 0 45px #06b6d4;
  transform: scale(0.95);
  transition: box-shadow 0.25s ease, transform 0.15s ease;
}




/* 📱 Adjust position for smaller screens */
@media (max-width: 480px) {
  .ctrl {
    bottom: 12vh; /* a bit closer to basket */
  }
}


/* Overlays */
.overlay{
  position:fixed; inset:0; display:none; place-items:center; z-index:40;
  background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75));
}
.panel{
  width:min(92vw, 720px); max-height:86vh; overflow:auto;
  background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-radius:22px; backdrop-filter: blur(10px);
  box-shadow: 0 20px 60px rgba(0,0,0,.45);
  padding:18px;
}
h1{ margin:0 0 8px; font-size: clamp(22px,5vw,30px) }
.sub{ color:var(--muted); margin:0 0 12px; }
.btn{
  padding:12px 14px; border-radius:14px; border:0; cursor:pointer; font-weight:800; color:#0b1221;
  background:linear-gradient(180deg,#93c5fd,#60a5fa);
}
.btn.red{ background:linear-gradient(180deg,#fca5a5,#f87171); color:#0b1221; }
.btn.green{ background:linear-gradient(180deg,#86efac,#22c55e); color:#0b1221; }
.btn.ghost{ background:transparent; color:#e5e7eb; border:1px solid rgba(255,255,255,.2); }

.offer-list{ display:grid; grid-template-columns: 1fr; gap:10px; margin:14px 0 }
.offer-card{
  display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:14px;
  background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
}
.offer-title{ font-weight:800 }
.offer-meta{ font-size:12px; color:var(--muted) }
/* Bomb with shake + glow */
.bomb-anim {
  animation: bombPulse 1s infinite ease-in-out;
  filter: drop-shadow(0 0 10px rgba(255,0,0,0.7));
  position: relative;
}

/* Smooth pulsing glow */
@keyframes bombPulse {
  0%   { transform: scale(1);   filter: drop-shadow(0 0 6px rgba(255,0,0,0.7)); }
  50%  { transform: scale(1.05); filter: drop-shadow(0 0 20px rgba(255,180,0,0.9)); }
  100% { transform: scale(1);   filter: drop-shadow(0 0 6px rgba(255,0,0,0.7)); }
}

/* Fuse fire */

/* Flickering + small bounce for fire */
@keyframes fuseFlicker {
  from { transform: scale(0.7); opacity: 0.6; }
  to   { transform: scale(1.3); opacity: 1; }
}
@keyframes fuseJump {
  0%   { transform: translateY(0); }
  50%  { transform: translateY(-4px); }
  100% { transform: translateY(0); }
}
/* Bomb Explosion Animation */
.bomb-explosion {
  position: absolute;
  width: 200px;
  height: 200px;
  pointer-events: none;
  z-index: 9999;
}

/* Main fireball */
/* Main fireball optimized */
.bomb-explosion::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(255,220,150,1) 0%, rgba(255,80,0,0.8) 50%, transparent 80%);
  border-radius: 50%;
  transform: translate(-50%, -50%) scale(0);
  opacity: 1;
  will-change: transform, opacity;
  animation: smoothExplosion 1.2s ease-out forwards;
}

/* Secondary shockwave simplified */
.bomb-explosion::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 150%;
  height: 150%;
  background: radial-gradient(circle, rgba(255,120,0,0.4) 0%, transparent 70%);
  border-radius: 50%;
  transform: translate(-50%, -50%) scale(0);
  will-change: transform, opacity;
  animation: smoothShockwave 1s ease-out 0.15s forwards;
}

/* Keyframes: only transform + opacity (GPU accelerated) */
@keyframes smoothExplosion {
  0%   { transform: translate(-50%, -50%) scale(0);   opacity: 1; }
  30%  { transform: translate(-50%, -50%) scale(1.8); opacity: 1; }
  60%  { transform: translate(-50%, -50%) scale(3);   opacity: 0.7; }
  100% { transform: translate(-50%, -50%) scale(4.5); opacity: 0; }
}

@keyframes smoothShockwave {
  0%   { transform: translate(-50%, -50%) scale(0);   opacity: 0.8; }
  40%  { transform: translate(-50%, -50%) scale(1.5); opacity: 0.5; }
  100% { transform: translate(-50%, -50%) scale(3.5); opacity: 0; }
}

/* Debris + sparks also optimized: use transform only */
.explosion-debris,
.explosion-spark,
.explosion-smoke {
  will-change: transform, opacity;
}

/* Debris particles */
.explosion-debris {
  position: absolute;
  background: linear-gradient(45deg, #8B4513, #654321);
  border-radius: 2px;
  pointer-events: none;
  z-index: 9997;
  box-shadow: 0 0 3px rgba(0,0,0,0.5);
}

.explosion-debris:nth-child(odd) {
  background: linear-gradient(45deg, #696969, #2F4F4F);
}

/* Fire sparks */
.explosion-spark {
  position: absolute;
  width: 6px;
  height: 6px;
  background: radial-gradient(circle, #ffff00 0%, #ff4500 60%, #8B0000 100%);
  border-radius: 50%;
  pointer-events: none;
  z-index: 9998;
  box-shadow: 0 0 8px #ff4500, 0 0 15px #ff0000;
}

/* Smoke clouds */
.explosion-smoke {
  position: absolute;
  width: 80px;
  height: 80px;
  background: radial-gradient(circle, rgba(60,60,60,0.8) 0%, rgba(40,40,40,0.6) 40%, rgba(20,20,20,0.3) 70%, transparent 100%);
  border-radius: 60% 40% 70% 50%;
  pointer-events: none;
  z-index: 9996;
}

/* Screen shake effect */
@keyframes screenShake {
  0%, 100% { transform: translate(0, 0) rotate(0deg); }
  10% { transform: translate(-2px, -1px) rotate(-0.5deg); }
  20% { transform: translate(2px, 1px) rotate(0.5deg); }
  30% { transform: translate(-1px, 2px) rotate(-0.3deg); }
  40% { transform: translate(1px, -2px) rotate(0.3deg); }
  50% { transform: translate(-2px, 1px) rotate(-0.2deg); }
  60% { transform: translate(2px, -1px) rotate(0.2deg); }
  70% { transform: translate(-1px, -2px) rotate(-0.1deg); }
  80% { transform: translate(1px, 2px) rotate(0.1deg); }
  90% { transform: translate(-1px, 1px) rotate(0deg); }
}

.screen-shake {
  animation: screenShake 0.8s ease-in-out;
}

/* Main fireball glow (smoother, more natural burn) */
@keyframes realExplosion {
  0% { 
    transform: translate(-50%, -50%) scale(0) rotate(0deg); 
    opacity: 1;
    filter: blur(0px) brightness(4) saturate(2);
    border-radius: 50%;
    box-shadow: 0 0 40px 20px rgba(255,180,0,0.9),
                0 0 80px 40px rgba(255,80,0,0.6);
  }
  10% { 
    transform: translate(-50%, -50%) scale(0.5) rotate(15deg); 
    filter: blur(2px) brightness(6) saturate(3);
    box-shadow: 0 0 60px 30px rgba(255,220,100,1),
                0 0 120px 60px rgba(255,100,0,0.8);
  }
  30% { 
    transform: translate(-50%, -50%) scale(2) rotate(90deg); 
    filter: blur(3px) brightness(3) saturate(1.5);
    box-shadow: 0 0 80px 40px rgba(255,150,0,0.9),
                0 0 160px 80px rgba(255,50,0,0.6);
  }
  60% { 
    transform: translate(-50%, -50%) scale(3.5) rotate(180deg); 
    opacity: 0.6;
    filter: blur(5px) brightness(1.5) saturate(1);
    box-shadow: 0 0 100px 50px rgba(255,100,0,0.6),
                0 0 200px 100px rgba(255,0,0,0.4);
  }
  100% { 
    transform: translate(-50%, -50%) scale(5) rotate(270deg); 
    opacity: 0;
    filter: blur(8px) brightness(0.5) saturate(0.5);
    box-shadow: 0 0 120px 60px rgba(255,80,0,0),
                0 0 240px 120px rgba(255,0,0,0);
  }
}


@keyframes shockwave {
  0% { 
    transform: translate(-50%, -50%) scale(0); 
    opacity: 0.8;
  }
  30% { 
    transform: translate(-50%, -50%) scale(1.5); 
    opacity: 0.6;
  }
  100% { 
    transform: translate(-50%, -50%) scale(4); 
    opacity: 0;
  }
}

/* Debris animations */
@keyframes debris1 {
  0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; }
  100% { transform: translate(120px, -80px) rotate(720deg) scale(0.3); opacity: 0; }
}

@keyframes debris2 {
  0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; }
  100% { transform: translate(-110px, -90px) rotate(-540deg) scale(0.2); opacity: 0; }
}

@keyframes debris3 {
  0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; }
  100% { transform: translate(140px, 60px) rotate(900deg) scale(0.4); opacity: 0; }
}

@keyframes debris4 {
  0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; }
  100% { transform: translate(-130px, 80px) rotate(-720deg) scale(0.3); opacity: 0; }
}

@keyframes debris5 {
  0% { transform: translate(0, 0) rotate(0deg) scale(1); opacity: 1; }
  100% { transform: translate(70px, -120px) rotate(1080deg) scale(0.1); opacity: 0; }
}

/* Spark animations */
@keyframes spark1 {
  0% { transform: translate(0, 0) scale(1); opacity: 1; box-shadow: 0 0 8px #ff4500; }
  100% { transform: translate(160px, -100px) scale(0.1); opacity: 0; box-shadow: 0 0 2px #ff4500; }
}

@keyframes spark2 {
  0% { transform: translate(0, 0) scale(1); opacity: 1; box-shadow: 0 0 8px #ff4500; }
  100% { transform: translate(-150px, -110px) scale(0.2); opacity: 0; box-shadow: 0 0 2px #ff4500; }
}

@keyframes spark3 {
  0% { transform: translate(0, 0) scale(1); opacity: 1; box-shadow: 0 0 8px #ff4500; }
  100% { transform: translate(180px, 70px) scale(0.1); opacity: 0; box-shadow: 0 0 2px #ff4500; }
}

@keyframes spark4 {
  0% { transform: translate(0, 0) scale(1); opacity: 1; box-shadow: 0 0 8px #ff4500; }
  100% { transform: translate(-170px, 90px) scale(0.2); opacity: 0; box-shadow: 0 0 2px #ff4500; }
}

/* Smoke animations */
@keyframes smoke1 {
  0% { 
    transform: translate(0, 0) scale(0.5) rotate(0deg); 
    opacity: 0.8; 
  }
  100% { 
    transform: translate(-60px, -150px) scale(2.5) rotate(180deg); 
    opacity: 0; 
  }
}

@keyframes smoke2 {
  0% { 
    transform: translate(0, 0) scale(0.3) rotate(0deg); 
    opacity: 0.7; 
  }
  100% { 
    transform: translate(80px, -140px) scale(2.8) rotate(-200deg); 
    opacity: 0; 
  }
}

@keyframes smoke3 {
  0% { 
    transform: translate(0, 0) scale(0.4) rotate(0deg); 
    opacity: 0.6; 
  }
  100% { 
    transform: translate(20px, -160px) scale(3) rotate(150deg); 
    opacity: 0; 
  }
}

/* Apply animations to elements */
.explosion-debris:nth-child(1) { animation: debris1 1.8s ease-out forwards; width: 8px; height: 12px; }
.explosion-debris:nth-child(2) { animation: debris2 1.6s ease-out forwards; width: 6px; height: 8px; }
.explosion-debris:nth-child(3) { animation: debris3 2s ease-out forwards; width: 10px; height: 6px; }
.explosion-debris:nth-child(4) { animation: debris4 1.7s ease-out forwards; width: 7px; height: 10px; }
.explosion-debris:nth-child(5) { animation: debris5 1.4s ease-out forwards; width: 5px; height: 7px; }

.explosion-spark:nth-child(1) { animation: spark1 1.2s ease-out forwards; }
.explosion-spark:nth-child(2) { animation: spark2 1.4s ease-out forwards; }
.explosion-spark:nth-child(3) { animation: spark3 1.1s ease-out forwards; }
.explosion-spark:nth-child(4) { animation: spark4 1.3s ease-out forwards; }

.explosion-smoke:nth-child(1) { animation: smoke1 2.5s ease-out 0.3s forwards; }
.explosion-smoke:nth-child(2) { animation: smoke2 2.8s ease-out 0.5s forwards; }
.explosion-smoke:nth-child(3) { animation: smoke3 2.6s ease-out 0.7s forwards; }

</style>
</head>
<body>
  

<div class="game-container" id="game">
  <div class="hud">
    <div id="score">Score: 0</div>
    <div class="pill" id="offersPill">🎁: <span id="offerCount">0</span></div>
    <div class="hearts" id="hearts"></div>
  </div>

  <div id="basket"></div>

  <div class="ctrl" id="left-btn">⟵</div>
  <div class="ctrl" id="right-btn">⟶</div>
</div>

<div id="flash"></div>



<!-- GAME OVER -->
<div class="overlay" id="gameOver">
  <div class="panel">
    <h1>Game Over</h1>
    <p class="sub">Final Score: <span id="finalScoreText">0</span></p>

    <h3 style="margin:8px 0 6px">Your Cart</h3>
    <div class="offer-list" id="offerList"></div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px">
      <button class="btn green" id="restartBtn">Play Again</button>
      <button class="btn green" id="homeBtn">Home</button>

<script>
document.getElementById('homeBtn').addEventListener('click', function() {
    window.location.href = 'home.html';
});
</script>

      <button class="btn ghost" id="shareBtn">Share Score</button>
    </div>
    <p class="sub" id="redeemNote" style="margin-top:10px"></p>
  </div>
</div>

<!-- AUDIO (replace with your files if needed) -->
<audio id="catch-sound" src="catch.mp3" preload="auto"></audio>
<audio id="crash-sound" src="crash.mp3" preload="auto"></audio>

<script>
// ========= ELEMENTS =========
const gameContainer = document.getElementById('game');
const basket = document.getElementById('basket');
const scoreDisplay = document.getElementById('score');
const heartWrap = document.getElementById('hearts');
const offerPillCount = document.getElementById('offerCount');
const leftBtn = document.getElementById('left-btn');
const rightBtn = document.getElementById('right-btn');
const catchSound = document.getElementById('catch-sound');
const crashSound = document.getElementById('crash-sound');

const over = document.getElementById('gameOver');
const finalScoreText = document.getElementById('finalScoreText');
const offerListEl = document.getElementById('offerList');
const restartBtn = document.getElementById('restartBtn');
const shareBtn = document.getElementById('shareBtn');
const redeemNote = document.getElementById('redeemNote');

// ========= STATE =========
let maxLives = 5;
let lives = maxLives;

let score = 0;
let basketX = 0;
let basketSpeed = 32;
let gameEnded = false;
let gamePaused = false;
let fallInterval = 1200; // will scale with score
let spawnTimer = null;
let consecutiveCatches = 0;
let offerCount = 0;

// Offer inventory (localStorage per-ID)
let userId = null;

// ========= UTILS & FX =========
const clamp = (x,min,max)=>Math.max(min,Math.min(max,x));
const vibrate = (ms)=>{ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch{} }
function sfx(audio, rateMin=0.96, rateMax=1.04){
  if(!audio) return;
  audio.currentTime = 0;
  audio.playbackRate = rateMin + Math.random()*(rateMax-rateMin);
  audio.play().catch(()=>{});
}
function screenShake(){ gameContainer.classList.add('shake'); setTimeout(()=>gameContainer.classList.remove('shake'), 250); }
function flash(){ const el = document.getElementById('flash'); el.style.opacity='1'; setTimeout(()=> el.style.opacity='0', 180); }
function pulseBasket(){ basket.classList.add('glow'); setTimeout(()=> basket.classList.remove('glow'), 320); }
function floatText(text, x, y){
  const el = document.createElement('div');
  el.className = 'float-text';
  el.textContent = text;
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 800);
}
function burstParticles(x, y, n=12, cls='particle', spread=60){
  const frag = document.createDocumentFragment();
  for(let i=0;i<n;i++){
    const p = document.createElement('div');
    p.className = cls;
    const dx = (Math.random() - .5) * spread * 2;
    const dy = (Math.random() - .2) * spread * 2;
    p.style.setProperty('--dx', dx+'px');
    p.style.setProperty('--dy', dy+'px');
    p.style.left = x + 'px';
    p.style.top = y + 'px';
    p.style.zIndex = 9999;
    frag.appendChild(p);
    setTimeout(()=> p.remove(), 900);
  }
  document.body.appendChild(frag);
}
function createBallTrail(x, y){
  const trail = document.createElement('div');
  trail.className = 'ball-trail';
  trail.style.left = x + 'px';
  trail.style.top = y + 'px';
  gameContainer.appendChild(trail);
  setTimeout(()=> trail.remove(), 400);
}
function bumpScore(){
  scoreDisplay.style.transform = 'scale(1.1)';
  setTimeout(()=> scoreDisplay.style.transform = 'scale(1)', 160);
}

// ========= ID & REDEEM CONTROL =========
const REDEEM_LOG_KEY = 'redeem_log_v1'; // { 'YYYY-MM-DD': { '<id>': { at, type, label } } }
const IST_TZ = 'Asia/Kolkata';
function getISTDateStr(){
  const parts = new Intl.DateTimeFormat('en-CA', { timeZone: IST_TZ, year:'numeric', month:'2-digit', day:'2-digit'}).formatToParts(new Date());
  const o = Object.fromEntries(parts.map(p=>[p.type,p.value]));
  return `${o.year}-${o.month}-${o.day}`;
}
function hashStr(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h<<5)-h + s.charCodeAt(i); h|=0; } return String(h); }
function deviceFingerprint(){
  const ua=navigator.userAgent||'', lang=navigator.language||'';
  const scr=(screen.width||0)+'x'+(screen.height||0)+'x'+(screen.colorDepth||0);
  const tz=Intl.DateTimeFormat().resolvedOptions().timeZone||'';
  return 'fp_'+hashStr([ua,lang,scr,tz].join('|'));
}
async function getIP(){
  try{
    const cached = sessionStorage.getItem('ip_cache_v1'); if(cached) return cached;
    const r = await fetch('https://api.ipify.org?format=json', {cache:'no-store'});
    const j = await r.json(); if(j && j.ip){ sessionStorage.setItem('ip_cache_v1', j.ip); return j.ip; }
  }catch(e){}
  return null;
}
async function resolveUserId(){
  // Prefer logged-in email (if your login page stored currentUser.email)
  try{
    const cu = JSON.parse(localStorage.getItem('currentUser') || 'null');
    if (cu && cu.email) return cu.email.toLowerCase();
  }catch(e){}
  const ip = await getIP();
  if (ip) return 'ip_'+ip;
  return deviceFingerprint();
}
function getOffersKey(id){ return id ? `caughtOffers_${id}` : 'caughtOffers_guest'; }
function readOffers(id){
  try{ return JSON.parse(localStorage.getItem(getOffersKey(id)) || '[]'); }catch(e){ return []; }
}
function writeOffers(id, arr){
  localStorage.setItem(getOffersKey(id), JSON.stringify(arr));
}
function getRedeemLog(){
  try{ return JSON.parse(localStorage.getItem(REDEEM_LOG_KEY) || '{}'); }catch(e){ return {}; }
}
function setRedeemLog(obj){
  localStorage.setItem(REDEEM_LOG_KEY, JSON.stringify(obj));
}
async function isRedeemBlockedToday(id){
  const today = getISTDateStr();
  const log = getRedeemLog();
  return !!(log[today] && log[today][id]);
}
async function markRedeemedToday(id, meta){
  const today = getISTDateStr();
  const log = getRedeemLog();
  if(!log[today]) log[today] = {};
  log[today][id] = { at: Date.now(), id, ...meta };
  setRedeemLog(log);
}

// ========= GAME INIT =========
// ❤️ Life settings
function updateHeartsUI() {
  heartWrap.innerHTML = '';
  for (let i = 0; i < lives; i++) {
    const img = document.createElement('img');
    img.src = 'red heart.png';
    img.className = 'heart';
    heartWrap.appendChild(img);
  }
}


function setScore(v){ score = Math.max(0, v|0); scoreDisplay.textContent = 'Score: ' + score; }
function setOfferCount(v){ offerCount = v|0; offerPillCount.textContent = String(offerCount); }

// ======== REWARD SCHEDULER (25, then every +10) ========
const REWARD_SEQ = ['pizza','zepto','meesho','job'];
let rewardDeck = [];
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function refillDeck(){
  rewardDeck = shuffle(REWARD_SEQ);
}
function nextRewardType(){
  if (rewardDeck.length === 0) refillDeck();
  return rewardDeck.shift();
}
let nextRewardScore = 25;     // first reward at 25
let rewardQueue = [];         // queue to drop one reward per spawn tick

function startGame(){
  // position basket center
  basketX = window.innerWidth/2 - basket.offsetWidth/2;
  basket.style.left = basketX + 'px';

  // reset state
  lives = maxLives; updateHeartsUI();
  setScore(0); setOfferCount(readOffers(userId).length);
  gameEnded = false; gamePaused = false; consecutiveCatches = 0;

  // reset reward scheduler
  nextRewardScore = 25;
  rewardQueue = [];
  refillDeck();

  // spawner
  if (spawnTimer) clearInterval(spawnTimer);
  fallInterval = currentDropInterval();
  spawnTimer = setInterval(spawnTick, fallInterval);
}
function endGame(){
  gameEnded = true; gamePaused = true;
  if (spawnTimer) clearInterval(spawnTimer);
  showGameOver();
}

// ========= MOVEMENT & SPAWN =========
function choosePath(type){
  const r = Math.random();

  // Before score 50 → only straight for diamonds
  if (type === 'diamond' && score < 50) {
    return { name: 'straight' };
  }
  if (type==='diamond'){
    // 50% straight, 35% zigzag, 10% pause zigzag, 5% sine
    if (r<0.50) return { name:'straight' };
    if (r<0.85) return { name:'zigzag', speedX: 2 + Math.random()*1.4, changeEvery: 18 + Math.floor(Math.random()*18) };
    if (r<0.95) return { name:'pause_zigzag', speedX: 2, changeEvery: 22, pauseEvery: 60, pauseFor: 14 };
    return { name:'sine', amp: 40 + Math.random()*60, period: 72 + Math.random()*60 };
  }
  if (type==='bomb') return { name:'straight' }; // fair
  return { name:'straight' }; // rewards
}

function getDiamondSpeed(sc){
  if (sc < 100){
    const t = sc / 100;
    return 1.9 + t * 2.0; // faster ramp
  }
  const steps = Math.floor((sc-100)/50);
  return Math.min(3.9 + steps * 0.25, 7.5);
}

function currentDropInterval(){
  // faster spawns at higher score
  const min = 700, max = 1300;
  const t = Math.min(score/200, 1); // 0..1
  return Math.round(max - (max-min)*t);
}

function spawnTick(){
  if (gamePaused || gameEnded) return;

  // adjust interval progressively
  const newInt = currentDropInterval();
  if (newInt !== fallInterval){
    fallInterval = newInt;
    clearInterval(spawnTimer);
    spawnTimer = setInterval(spawnTick, fallInterval);
  }

  // schedule reward thresholds (25, then every +10)
  while (score >= nextRewardScore) {
    rewardQueue.push(1);       // enqueue one reward for each crossed threshold
    nextRewardScore += 10;     // move to the next +10 mark
  }

  // normal spawns
  const dropCount = Math.random() < 0.2 ? 2 : 1; // sometimes 2 items
  const usedX = [];
  for (let i=0;i<dropCount;i++){
    let posX; let attempts=0;
    do { posX = Math.random()*(window.innerWidth - 80); attempts++; }
    while(usedX.some(x=>Math.abs(x-posX)<100) && attempts<10);
    usedX.push(posX);
    createItem(posX, /*forceReward*/false);
  }

  // drop exactly one reward per tick if queued
  if (rewardQueue.length > 0){
    createItem(Math.random()*(window.innerWidth - 80), /*forceReward*/true);
    rewardQueue.shift();
  }
}

function createItem(forcedX=null, forceReward=false){
  if (gameEnded || gamePaused) return;

  // Decide type
  let type='diamond', image='ball.png';
  if (forceReward){
    type = nextRewardType();
    image = rewardImage(type);
  } else {
    // NO random rewards anymore (as requested) → only diamonds/bombs here
const r = Math.random();
if (score > 10 && r < 0.16) { // was 0.18 → now 0.35 
    type = 'bomb';
    image = 'bomb 3.png';
    
}


    else { type='diamond'; image='ball.png'; }
  }

  const item = document.createElement('div');
  item.className = 'falling-item';
  item.dataset.type = type;
  item.style.left = (forcedX!==null ? forcedX : Math.random()*(window.innerWidth-80)) + 'px';
  item.style.top = (Math.random()*80) + 'px';
  item.style.backgroundImage = `url('${image}')`;

  if (type === 'bomb') {
    item.classList.add('bomb-anim'); // ✅ bomb animation
    item.style.width = '90px';
    item.style.height = '90px';
    item.style.backgroundSize = 'contain';
  }

  gameContainer.appendChild(item);

  // per-item path state
  item._path = choosePath(type);
  item._t = 0; item._dir = Math.random()<0.5 ? -1 : 1; item._baseX = parseFloat(item.style.left);

  // speed
  let speed = 4;
  if (type==='diamond') speed = getDiamondSpeed(score);
  else if (type==='bomb'){
    const ls = Math.min(score, 250);
    speed = 3 + (ls/250) * 2.5; // 3 → 5.5
  } else { // rewards slow & fair
    speed = 4.2;
  }

function fall(){
  if (gameEnded){ item.remove(); return; }
  if (gamePaused){ requestAnimationFrame(fall); return; }

  let top = parseFloat(item.style.top);
  let left = parseFloat(item.style.left);
  const maxLeft = window.innerWidth - item.offsetWidth;
  let allowY = true;

  // path
  switch(item._path.name){
    case 'straight': break;
    case 'zigzag':
      left += item._dir * item._path.speedX;
      item._t++;
      if (item._t % item._path.changeEvery === 0) item._dir *= -1;
      if (left<=0){ left=0; item._dir=1; }
      if (left>=maxLeft){ left=maxLeft; item._dir=-1; }
      if (item._t % 3 === 0) createBallTrail(left, top);
      break;
    case 'pause_zigzag':
      item._t++;
      const inPause = (item._t % item._path.pauseEvery) < item._path.pauseFor;
      allowY = !inPause;
      left += item._dir * item._path.speedX;
      if (item._t % item._path.changeEvery === 0) item._dir *= -1;
      if (left<=0){ left=0; item._dir=1; }
      if (left>=maxLeft){ left=maxLeft; item._dir=-1; }
      if (item._t % 3 === 0) createBallTrail(left, top);
      break;
    case 'sine':
      item._t++;
      left = item._baseX + (item._path.amp * Math.sin((2*Math.PI*item._t)/item._path.period));
      left = clamp(left, 0, maxLeft);
      if (item._t % 3 === 0) createBallTrail(left, top);
      break;
  }

  if (allowY) top += speed;
  item.style.left = left + 'px';
  item.style.top = top + 'px';
  item.style.zIndex = '5';

  if (top + item.offsetHeight < window.innerHeight){
    if (isCaught(item)) {
      if (type === 'bomb') {
        // 🔥 Explosion animation at basket
        const basket = document.getElementById("basket");
        const basketRect = basket.getBoundingClientRect();
        bombExplosionAnimation(
          basketRect.left + basketRect.width / 2,
          basketRect.top + basketRect.height / 2
        );

        // End game immediately after explosion
        item.remove();

// 🛑 Freeze for 0.3s, then trigger game over
setTimeout(() => {
  endGame();
}, 600);


      } else {
        // Normal item (diamond, etc.)
        handleCatch(item);
      }
    } else {
      requestAnimationFrame(fall);
    }
  } else {
    // Missed item
    item.remove();
    if (type === 'diamond'){
      consecutiveCatches = 0;
      lives = Math.max(0, lives - 1);
      updateHeartsUI();
      if (lives <= 0){ endGame(); }
    }
  }
}
requestAnimationFrame(fall);

}

function isCaught(item){
  const it = item.getBoundingClientRect();
  const b = basket.getBoundingClientRect();
  const verticalOffset = 8, horizontalBuffer = 35;
  return (
    it.bottom >= b.top + verticalOffset &&
    it.right - horizontalBuffer >= b.left &&
    it.left + horizontalBuffer <= b.right
  );
}

// ========= CATCH HANDLERS =========
function handleCatch(item){
  const type = item.dataset.type;
  const b = basket.getBoundingClientRect();
  const cx = b.left + b.width/2, cy = b.top + 10;

  if (type==='diamond'){
    setScore(score+1);
    consecutiveCatches++;
    sfx(catchSound); bumpScore(); pulseBasket();
    burstParticles(cx, cy, 12, 'particle', 70);
    floatText('+1', cx, cy);

    // 5-in-a-row bonus life restore (cap at maxLives)
    if (consecutiveCatches === 5 && lives < maxLives) {
      lives = Math.min(maxLives, lives + 1);
      updateHeartsUI();
      consecutiveCatches = 0;

      for (let i = 0; i < 22; i++) {
        const c = document.createElement('div');
        c.className = 'confetti';
        const dx = (Math.random() - .5) * 180,
              dy = (Math.random() - .2) * 180;
        c.style.setProperty('--dx', dx + 'px');
        c.style.setProperty('--dy', dy + 'px');
        c.style.left = cx + 'px';
        c.style.top = cy + 'px';
        c.style.zIndex = 9999;
        document.body.appendChild(c);
        setTimeout(() => c.remove(), 900);
      }
      floatText('LIFE RESTORED!', cx, cy - 16);
    }

    item.remove();
  }
  else if (type==='bomb'){
    sfx(crashSound); vibrate(120); screenShake(); flash();
    item.remove();
    endGame(); // straight game over on bomb
  }
  else {
    // Offer caught ⇒ add to basket (localStorage), no pause
    sfx(catchSound); pulseBasket();
    burstParticles(cx, cy, 14, 'particle', 70);
    const meta = offerMeta(type);
    addOfferToInventory(meta);
    setOfferCount(offerCount+1);
    floatText('OFFER 🎁', cx, cy);
    item.remove();
  }
}

// ========= OFFERS =========
function rewardImage(type){
  if (type==='pizza') return 'pizza.png';
  if (type==='meesho') return 'meesho voucher.png';
  if (type==='zepto') return 'zepto coupon.png';
  if (type==='job') return 'job delivery.png';
  return 'pizza.png';
}
function offerMeta(type){
  if (type==='pizza') return {type, label:'Pizza Offer', value:'Flat 5% off on your next order!'};
  if (type==='meesho') return {type, label:'Meesho Discount', value:'Flat 7% off on your next order!'};
  if (type==='zepto') return {type, label:'Zepto Reward', value:'Flat 10% off on your next order!'};
  if (type==='job') return {type, label:'Job Hunt Bonus', value:'Get priority access to internships!'};
  return {type:'offer', label:'Offer', value:'Special deal!'};
}
function addOfferToInventory(meta){
  const arr = readOffers(userId);
  arr.push({...meta, caughtAt: Date.now(), redeemed:false});
  writeOffers(userId, arr);
}

// ========= GAME OVER UI & REDEEM =========
function showGameOver() {
  finalScoreText.textContent = score;

  // build offer list
  offerListEl.innerHTML = '';
  const arr = readOffers(userId);

  if (!arr.length) {
    offerListEl.innerHTML =
      `<div class="offer-card"><div>No offers yet — catch some in your next run!</div></div>`;
  } else {
    arr.forEach((it, idx) => {
      const card = document.createElement('div');
      card.className = 'offer-card';
      card.innerHTML = `
        <div>
          <div class="offer-title">${it.label || 'Offer'}</div>
          <div class="offer-meta">${it.value || ''}</div>
        </div>
   <div style="display:flex; gap:8px; align-items:center">
  <a href="home.html">
    <img src="home button.png"
         alt="Home"
         title="Go to Home"
         style="cursor:pointer;width:40px;height:40px;">
  </a>
</div>

      `;
      offerListEl.appendChild(card);
    });
  }

  // 🛡️ Redirect if user not logged in
  const storedData = JSON.parse(localStorage.getItem("currentUser"));
  if (!storedData || !storedData.username || !storedData.email) {
    window.location.href = "login.html";
    return;
  }

  const userData = storedData;
  const email = userData?.email || "";

  // Keys for cart/reward tracking
  const rewardKey = `caughtOffers_${email}`;
  const timeKey = `rewardStartTime_${email}`;

  // ⏳ Reset cart if expired (on page load)
  (function resetCartIfExpired() {
    const rewardTime = localStorage.getItem(timeKey);
    const now = Date.now();
    if (rewardTime && now - parseInt(rewardTime, 10) > 2 * 60 * 1000) {
      localStorage.removeItem(rewardKey);
      localStorage.removeItem(timeKey);
      console.log("Cart reset after 2 minutes.");
    }
  })();

  // Personalize welcome title
  const welcomeTitle = document.getElementById("welcome-title");
  if (welcomeTitle && userData?.username) {
    welcomeTitle.textContent = `Welcome, ${userData.username}! Catch The Ball!`;
  }

  over.style.display = 'grid';
}


// ========= INPUT =========
function move(dir){
  if (gamePaused || gameEnded) return;
  const containerWidth = gameContainer.clientWidth;
  const bw = basket.offsetWidth;
  if (dir==='left'){ basketX = Math.max(0, basketX - basketSpeed); }
  else { basketX = Math.min(containerWidth - bw, basketX + basketSpeed); }
  basket.style.left = basketX + 'px';
}
document.addEventListener('keydown', e=>{
  if (e.key==='ArrowLeft') move('left');
  else if (e.key==='ArrowRight') move('right');
});
['touchstart','click'].forEach(ev=>{
  leftBtn.addEventListener(ev, ()=> move('left'));
  rightBtn.addEventListener(ev, ()=> move('right'));
});

// ========= BUTTONS =========
restartBtn.addEventListener('click', ()=>{
  over.style.display = 'none';
  setOfferCount(readOffers(userId).length);
  startGame();
});

shareBtn.addEventListener('click', ()=>{
  const txt = `I scored ${score} in CHACH — Catch the Offer! 🎮`;
  if (navigator.share){
    navigator.share({text:txt}).catch(()=>{});
  } else {
    navigator.clipboard.writeText(txt).then(()=> alert('Score copied! Share anywhere.'));
  }
});

// ========= RESIZE =========
window.addEventListener('resize', ()=>{
  if (gameEnded || gamePaused) return;
  basketX = Math.min(window.innerWidth - basket.offsetWidth, basketX);
  basket.style.left = basketX + 'px';
});

// ========= BOOT =========
(async function boot(){
  userId = await resolveUserId(); // email -> IP -> device fp
  setOfferCount(readOffers(userId).length);
  startGame();
})();
function bombExplosionAnimation(x, y) {
    // Add screen shake to entire game container
    const gameContainer = document.body; // or your main game container
    gameContainer.classList.add('screen-shake');
    setTimeout(() => gameContainer.classList.remove('screen-shake'), 800);

    // Create main explosion
    const explosion = document.createElement('div');
    explosion.className = 'bomb-explosion';
    explosion.style.left = (x - 100) + 'px';
    explosion.style.top = (y - 100) + 'px';
    document.body.appendChild(explosion);

    // Create debris particles (metal/concrete chunks)
    for (let i = 0; i < 5; i++) {
        const debris = document.createElement('div');
        debris.className = 'explosion-debris';
        debris.style.left = x + 'px';
        debris.style.top = y + 'px';
        explosion.appendChild(debris);
    }

    // Create fire sparks
    for (let i = 0; i < 4; i++) {
        const spark = document.createElement('div');
        spark.className = 'explosion-spark';
        spark.style.left = x + 'px';
        spark.style.top = y + 'px';
        explosion.appendChild(spark);
    }

    // Create smoke clouds
    for (let i = 0; i < 3; i++) {
        const smoke = document.createElement('div');
        smoke.className = 'explosion-smoke';
        smoke.style.left = (x - 40) + 'px';
        smoke.style.top = (y - 40) + 'px';
        explosion.appendChild(smoke);
    }

    // Remove explosion after all animations complete
    setTimeout(() => explosion.remove(), 3000);
}

// ========= BUTTON GLOW (fixed typo) =========
const buttons = document.querySelectorAll('.ctrl');
buttons.forEach(btn => {
  btn.addEventListener('touchstart', () => triggerGlow(btn));
  btn.addEventListener('mousedown', () => triggerGlow(btn)); // for desktop clicks
});
function triggerGlow(button) {
  button.classList.add('glow-effect');
  setTimeout(() => {
    button.classList.remove('glow-effect');
  }, 250);
}

</script>
</body>
</html>

